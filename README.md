## Open eClass 2.3
 
Το repository αυτό περιέχει μια __παλιά και μη ασφαλή__ έκδοση του eclass.
Προορίζεται για χρήση στα πλαίσια του μαθήματος
[Προστασία & Ασφάλεια Υπολογιστικών Συστημάτων (ΥΣ13)](https://ys13.chatzi.org/), __μην τη
χρησιμοποιήσετε για κάνενα άλλο σκοπό__.
 
 
### Χρήση μέσω docker
```
# create and start (the first run takes time to build the image)
docker-compose up -d
 
# stop/restart
docker-compose stop
docker-compose start
 
# stop and remove
docker-compose down -v
```
 
To site είναι διαθέσιμο στο http://localhost:8001/. Την πρώτη φορά θα πρέπει να τρέξετε τον οδηγό εγκατάστασης.
 
 
### Ρυθμίσεις eclass
 
Στο οδηγό εγκατάστασης του eclass, χρησιμοποιήστε __οπωσδήποτε__ τις παρακάτω ρυθμίσεις:
 
- Ρυθμίσεις της MySQL
 - Εξυπηρέτης Βάσης Δεδομένων: `db`
 - Όνομα Χρήστη για τη Βάση Δεδομένων: `root`
 - Συνθηματικό για τη Βάση Δεδομένων: `1234`
- Ρυθμίσεις συστήματος
 - URL του Open eClass : `http://localhost:8001/` (προσοχή στο τελικό `/`)
 - Όνομα Χρήστη του Διαχειριστή : `drunkadmin`
 
Αν κάνετε κάποιο λάθος στις ρυθμίσεις, ή για οποιοδήποτε λόγο θέλετε να ρυθμίσετε
το openeclass από την αρχή, διαγράψτε το directory, `openeclass/config` και ο
οδηγός εγκατάστασης θα τρέξει ξανά.
 
## 2022 Project 1
 
Εκφώνηση: https://ys13.chatzi.org/assets/projects/project1.pdf
 
 
### Μέλη ομάδας
 
- sdi1800056, Αντώνης Καλαμάκης
- sdi1800215, Κωνσταντίνος Χωνάς Βαστάρδος
 
# Report
 
 
 
<h1> **Defences** </h1>
 
<ul>
<li> Defence for sql injection attacks</li>
 
Χρήση SQLi βιβλιοθήκης και συγκεκριμένα χρήση prepared statements.
  
Φτιάξαμε μια συνάρτηση runQuery που ουσιαστικά φτιάχνει ένα καινούργιο connection προς την βάση και χρησιμοποιεί την SQLi βιβλιοθήκη με χρήση prepared statements και επιστρέφει το result, false σε περίπτωση error ή το insert id σε περίπτωση insert. Σαν ορίσματα δίναμε το query σαν string με “?” σε κάθε σημείο που έχει μεταβλητή, array από όλες τις μεταβλητές που πρέπει να περάσουμε και αν χρειάζεται την βάση που αναφέρετε το συγκεκριμένο query. 
  
Για λόγο εξοικονόμησης χρόνου αυτή την συνάρτηση την χρησιμοποιούμε μόνο σε σημεία που θα μπορούσε να γίνει κάποιο sql injection και όχι σε όλα τα query. Είδαμε όμως ότι γίνεται η χρήση unsafe συναρτήσεων για autoquotes κλπ και τα αντικαταστήσαμε όλα με την mysql_real_escape_string.
Αυτή την συνάρτηση την προσθέσαμε στο baseTheme.php το οποίο καταλάβαμε ότι γίνεται include σε όλα τα υπόλοιπα αρχεία.
 
<li>Defence for XSS attacks</li>
 
Χρήση της συνάρτησης htmlspecialchars() που καθιστά άχρηστο οποιοδήποτε html tag injection.
 
Συγκεκριμένα την βάλαμε μέσα στην συνάρτηση runQuery που προαναφέρθηκε έτσι ώστε να γίνεται filtering του input του χρήστη πριν μπει στην βάση έτσι ώστε όταν το ζητήσουμε από την βάση να μην υπάρχει πιθανότητα να μας ξεφύγει κάτι.
 
Επιπλέον χρησιμοποιήθηκε  οπουδήποτε μπορεί ο χρήστης να γράψει κάποιο text.
 
 
<li>Defence for CSRF attacks</li>
 
Θέσαμε το cookie samesite = strict για να κάνουμε restrict to cross-site sharing.
 
Επίσης Θέσαμε to header X-FRAME-OPTIONS = SAMEORIGIN για την αποφυγή attacks μέσω iframes.
 
Επιπλέον χρησιμοποιήσαμε csrf token στις περισσότερες φόρμες που μπορούσε να γίνει κάτι σημαντικό, για εξοικονόμηση χρόνου. Φόρμες όπως, να καταφέρουν να γράψει κάποιο μήνυμα στην περιοχή συζητήσεων μέσω csrf attack δεν το θεωρήσαμε άξιο προστασίας.
  
Δοκιμάσαμε κάποιες από τις open-source βιβλιοθήκες που προσθέτουν csrf token αλλά είδαμε ότι το πιο εύκολο πράγμα θα ήταν να βάλουμε το baseTheme.php να φτιάχνει στο $_SESSION ένα νέο πεδίο με όνομα _token και να αλλάζει αυτό με κάθε refresh ή πηγαίνοντας σε άλλη σελίδα.  Τέλος, σε κάθε φόρμα που κρίναμε ότι χρειάζεται, να το χρησιμοποιεί και όταν γίνεται submit να ελέγχει αν τα 2 tokens είναι ίδια.
  
Είδαμε ότι ο admin με ένα απλό get request μπορούσε να κάνει έναν χρήστη class admin ή professor ή ακόμα και να τον διαγράψει. Προσθέσαμε και εκεί csrf token σε περίπτωση που κάποιος προσπαθήσει να κάνει αυτό το request. 
 
 
<li>Defence for RFI attacks</li>
Τα δυο σημεία που μπορούσε ένας attacker να ανεβάσει αρχείο είναι οι εργασίες και η ανταλλαγή αρχείων, στις εργασίες κάναμε secure το input του χρήστη έτσι ώστε να μην μπορέσει να αλλάξει το path. Επίσης είδαμε ότι αν προσπαθήσει ο χρήστης να χρησιμοποιήσει ένα id το οποίο δεν έχει γίνει setup(δεν είναι valid εργασία), αντί να φτιάχνει ένα directory με το id αυτό, να πάει και να κάνει die() έτσι ώστε να μην υπάρχει η δυνατότητα να φτιάξει καινούργιο directory με λάθος όνομα.
  
Αλλάξαμε το όνομα των αρχείων σε κάτι μεγαλύτερο και δυσκολότερο έτσι ώστε να μην μπορεί να χρησιμοποιηθεί κάποιο dirbuster. Τέλος, βάλαμε index.php αρχεία σε σημεία που μπορεί ο attacker να δει εύκολα το directory listing έτσι ώστε να μην υπάρχει περίπτωση να γίνει leak το secret name.  
 
<li>Για εργαλεία που δεν χρησιμοποιούνται</li>
Είδαμε ότι μέσω csrf μπορούσε κάποιος admin να ενεργοποιήσει νέα εργαλεία τα οποία μπορούν να γίνουν εύκολα exploit και προσπαθήσαμε να μειώσουμε αυτή την πιθανότητα αφαιρώντας την δυνατότητα να ενεργοποιήσει νέα εργαλεία ή να προσθέσει έξτρα πράγματα στο μάθημα.
  
Κάποια από αυτά ήταν ότι αν ενεργοποιηθεί το documents εργαλείο μπορεί ο καθηγητής να ανεβάσει αρχείο στο μάθημα και σαν path να το κάνει ότι θέλει εκείνος. Αυτό μαζί με κάποια άλλα κενά διορθώθηκαν. 
</ul>
 
<h1> **Attacks** </h1>
Επειδή στην αρχή προσπαθήσαμε να κάνουμε secure το δικό μας eclass, είχαμε σημειώσει κάποια finds από τότε και τα τρέξαμε σε περίπτωση που τους είχαν ξεφύγει. Είδαμε ότι ο target δεν είχε βάλει στο header  X-FRAME-OPTIONS = SAMEORIGIN με αποτέλεσμα να μην γίνεται άχρηστη η χρήση iframe. Έτσι δώσαμε 2 links στον admin και προσπαθήσαμε να κάνουμε τον χρήστη καθηγητή για να ενεργοποιηθούν ενέργειες που θα χρειαζόντουσαν professor previleges. 

Κατά το csrf attack μας επίσης προσθέσαμε την δυνατότητα να καταγραφεί όλους όσους μπήκαν στο puppies για να δούμε ότι όντως πατήθηκε το κουμπί.

Μετά από την αποτυχία αυτού, είδαμε μήπως είχαν βρει το vulnerability με το id της εργασίας το οποίο δεν είχαν βρει. Έτσι προσπαθήσαμε να ανεβάσουμε ένα αρχείο σε διαφορετικό directory από αυτό που θα έπρεπε(χωρίς την χρήση του secret, αφού δεν είχε γίνει setup στην βάση) και φτάσαμε σε deadend γιατί δεν είχαμε το όνομα του αρχείου που μόλις ανεβάσαμε μιας και ήταν διαφορετικό από το default.

Προσπαθήσαμε να δούμε σε όλα τα πιθανά inputs(hidden ή μη) να κάνουμε xss ή sqli attack αλλά κανένα δεν λειτούργησε.

Τελικά βρήκαμε ένα στο unregcourse.php στο url όπου έπρεπε να δοθεί το course id και με χρήση union select καταφέραμε να βγάλουμε το file path των εργασιών που μόλις ανεβάσαμε από το table assignment_submit του μαθήματος.

Είδαμε ότι καθώς προσπαθούσαμε να τρέξουμε το αρχείο που μόλις ανεβάσαμε έβγαζε not found και επειδή δεν μπορούσαμε ούτε να δούμε το directory listing των φακέλων, σκεφτήκαμε ότι θα έχουν κλείσει τα get paths για το directory courses. 

Γνωρίζοντας αυτήν την πληροφορία δοκιμάσαμε να βάλουμε το id σε κάτι της μορφής “../../../79” (79 τυχαίο νούμερο, οποίο θέλαμε βάζαμε αρκεί να είναι καινούργιο). Όταν υπάρχει id που δεν έχει γίνει setup όμως το έχουν φτιάξει έτσι ώστε να μην εμφανίζει την φόρμα υποβολής εργασίας, αλλά με ένα copy element και paste element (για να πάρουμε και το csrf token) καταφέραμε να ανεβάσουμε εργασία με το δικό μας id.  Kαι τέλος,  μέσω του SQL injection μπορούσαμε να δούμε το όνομα όπου ανέβηκε η εργασία μας. Παρατηρήσαμε επίσης ότι είχαν αλλάξει και το όνομα με το οποίο ανεβαίνει η εργασία στον server (κανονικά είναι της μορφής lastname firstname.txt αν ανεβάζαμε txt αρχείο) και το είχαν κάνει της μορφής lastname firstname ΧΧΧΧΧΧΧΧΧ.ΧΧΧΧ.txt οπού Χ τυχαίοι χαρακτήρες. 

Έχοντας λοιπόν αλλάξει το id σε ../../../79 η εργασία ανέβαινε σε οποίο φάκελο εμείς θέλαμε ο οποίος ήταν εκτός του courses, άρα και εκτός του get path restriction που είχαν φτιάξει στο conf του apache άρα βρήκαμε το path και το όνομα του αρχείου.

Επειδή από το default version του eclass έλεγχε για αρχεία php και τα έκανε μη-executable σκεφτήκαμε να ανεβάσουμε pht αρχείο το οποίο δεν το είχε στο original eclass άρα υπήρχε πιθανότητα να τους είχε ξεφύγει. 

Και είδαμε ότι δεν έλεγχαν για pht, βάλαμε ένα script για να πάρουμε πληροφορίες από το openeclass/conf αρχείο και πήραμε τον κωδικό του drunkadmin. 
Τέλος, ανεβάσαμε ένα καινούργιο αρχείο με το c99 shell για την php για να έχουμε μια εικόνα σε όλον τον server.

Κάναμε deface το site κάνοντας delete τα πάντα :D

also db is empty :O
